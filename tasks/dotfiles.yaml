---
- name: Clone dotfiles repo (with submodules)
  ansible.builtin.git:
    repo: "{{ dotfiles_repo }}"
    dest: "{{ dotfiles_dest }}"
    recursive: true
    update: true
    version: cleanup # Or your branch
  register: dotfiles_clone

- name: Update Dotbot and other submodules
  ansible.builtin.command:
    cmd: git submodule update --init --recursive
    chdir: "{{ dotfiles_dest }}"
  when: dotfiles_clone.changed

- name: Run Dotbot to install/symlink dotfiles
  ansible.builtin.command:
    cmd: "{{ dotfiles_dest }}/install -c {{ dotbot_config }}"
    chdir: "{{ dotfiles_dest }}"
  # cmd: "{{ dotbot_bin }} -d {{ dotfiles_dest }} -c {{ dotbot_config }}"

# Optional: Hide untracked files in repo (if you still want bare-repo-like behavior)
# - name: Hide untracked dotfiles in home (bare repo style)
#   ansible.builtin.command:
#     cmd: git --git-dir={{ ansible_env.HOME }}/.dotfiles.git --work-tree={{ ansible_env.HOME }} config --local status.showUntrackedFiles no
#   when: false  # Disable if fully switching to Dotbot symlinks
